<apex:page standardStylesheets="false" showHeader="true" sidebar="false"
           controller="EntityListController">

    <apex:stylesheet value="{!URLFOR($Resource.resources, 'bootstrap/css/bootstrap.min.css')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.resources, 'font-awesome/css/font-awesome.min.css')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.resources, 'jquery/ui/jquery-ui.min.css')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.resources, 'styles/css/entity-list.css')}"/>

    <apex:includeScript value="{!URLFOR($Resource.resources, 'jquery/jquery-1.11.3.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.resources, 'jquery/ui/jquery-ui.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.resources, 'bootstrap/js/bootstrap.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.resources, 'js/entity-list.js')}"/>

    <script src="/soap/ajax/15.0/connection.js" type="text/javascript"></script>
    <script src="/soap/ajax/15.0/apex.js" type="text/javascript"></script>

    <div class="container">
        <div class="col-md-12">
            <apex:form id="table-form" styleClass="form-group">
                <apex:outputPanel id="table-panel">

                    <apex:dataTable value="{!entities}" var="entity" styleClass="table table-bordered table-condensed" columnClasses="text-center"
                                    captionClass="text-center text-info header">

                        <apex:facet name="caption">
                            Entities
                        </apex:facet>

                        <apex:column headerValue="Name">
                            <apex:inputField value="{!entity.Name}" styleClass="input text-center" onchange="resolveChanges('{!entity.Id}')" required="true"/>
                        </apex:column>

                        <apex:column headerValue="Table name">
                            <apex:inputField value="{!entity.TableName__c}" styleClass="input text-center" onchange="resolveChanges('{!entity.Id}')"
                                             onfocus="generateTableName(this)" required="true"/>
                        </apex:column>

                        <apex:column headerValue="Actions" styleClass="text-center">
                            <apex:commandLink action="{!URLFOR($Action.Entity__c.Edit, entity.Id)}" rendered="{!entity.Id != null}">
                                <i class="fa fa-pencil-square-o" data-toggle="popover" data-placement="left" data-trigger="hover"
                                   data-content="Edit"></i>
                            </apex:commandLink>

                            <apex:commandLink onclick="deleteEntity('{!entity.Id}')" rendered="{!entity.Id != null}" oncomplete="init()">
                                <i class="fa fa-times" data-toggle="popover" data-placement="right" data-trigger="hover" data-content="Delete"></i>
                            </apex:commandLink>
                        </apex:column>

                    </apex:dataTable>

                    <apex:pageMessages />

                    <apex:actionFunction action="{!deleteEntity}" name="callDeleteEntity" reRender="table-panel" oncomplete="init()" immediate="true">
                        <apex:param name="entityId" value="" assignTo="{!entityId}"/>
                    </apex:actionFunction>

                    <apex:actionFunction action="{!resolveChanges}"  name="callResolveChanges" reRender="apply-block">
                        <apex:param name="entityId" value="" assignTo="{!entityId}"/>
                    </apex:actionFunction>

                    <apex:outputPanel id="apply-block">
                        <apex:commandButton action="{!discardChanges}" rendered="{!wereChanges}" value="Discard changes" styleClass="btn btn-warning pull-right"
                                            onclick="fillForReset()"/>

                        <apex:commandButton action="{!applyChanges}" reRender="table-panel,generate-table-block" rendered="{!wereChanges}" value="Apply changes" style="margin-right:10px;"
                                            styleClass="btn btn-info pull-right apply-button" oncomplete="initAndDeleteErrors()"/>
                    </apex:outputPanel>

                    <apex:commandLink action="{!addRow}" reRender="table-panel" oncomplete="initAndDeleteErrors()">
                        <i class="fa fa-plus-square-o" data-toggle="popover" data-placement="right" data-trigger="hover"
                           data-content="Add new entity"></i>
                    </apex:commandLink>
                </apex:outputPanel>

                    <apex:actionFunction name="callStartRequest" action="{!startRequest}" reRender="result"/>
                 </apex:form>

                 <apex:form >
                     <apex:actionFunction name="callGetResult" action="{!getResult}" immediate="true" reRender=""/>
                 </apex:form>

            <apex:form id="generate-table-block">
                 <apex:commandButton id="generate-table" value="Generate tables" action="{!startRequest}" rendered="{!isVisible}"  status="status" styleClass="btn btn-large" style="margin-left:430px;"
                        reRender="generate-table-block,successfulModalWindow,result,failedModalWindow"/>

                        <apex:outputPanel id="successfulModalWindow">
                             <apex:outputPanel styleClass="popupBackground" layout="block" rendered="{!displaySuccessfulModalWindow}"/>
                             <apex:outputPanel styleClass="custPopup" layout="block" rendered="{!displaySuccessfulModalWindow}">

                                   Tables have been successfully generated.<br/><br/><br/>

                             <apex:commandButton value="close" action="{!closeSuccessfulModalWindow}" rerender="successfulModalWindow" style="margin-left:400px;"/>
                             </apex:outputPanel>
                        </apex:outputPanel>

                        <apex:outputPanel id="failedModalWindow">
                              <apex:outputPanel styleClass="popupBackground" layout="block" rendered="{!displayFailedModalWindow}"/>
                              <apex:outputPanel styleClass="custPopup" layout="block" rendered="{!displayFailedModalWindow}">

                                    Tables have not been generated .<br/><br/><br/>

                              <apex:commandButton value="close" action="{!closeFailedModalWindow}" rerender="failedModalWindow" style="margin-left:400px;"/>
                              </apex:outputPanel>
                        </apex:outputPanel>
            </apex:form>

            <apex:form >
                 <apex:actionStatus id="status">
                        <apex:facet name="start">
                        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.75; z-index: 1000; background-color: white;">
                        </div>
                        <div style="position: fixed; left: 0; top: 10; bottom: 0; right: 0; z-index: 1001; margin: 15% 47%">
                            <img src="http://upload.wikimedia.org/wikipedia/commons/e/ed/Cursor_Windows_Vista.gif" />
                        </div>
                        </apex:facet>
                 </apex:actionStatus>
            </apex:form>

        </div>
    </div>

    <div id="dialog-confirm" title="Delete this entity?" style="display: none">
        <p><i class="fa fa-exclamation-circle"></i>These item will be permanently deleted and cannot be recovered. Are you sure?</p>
    </div>

</apex:page>